<!DOCTYPE html>
<html>
  <head>
    <title>Robotic Arm Control</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="../static/style.css">
  </head>
  <body>
    <h1>Robotic Arm Control</h1>
    <div class="container">
      <form method="POST" action="/move" enctype="application/json" id="move_form">
        <label for="base">Base</label>
        <input type="range" min="0" max="360" step="1" name="base" id="base" value="90">
        <br>
        <label for="shoulder">Shoulder</label>
        <input type="range" min="-24" max="156" step="1" name="shoulder" id="shoulder" value="90">
        <br>
        <label for="elbow">Elbow</label>
        <input type="range" min="-121" max="59" step="1" name="elbow" id="elbow" value="-31">
        <br>
        <label for="wrist">Wrist</label>
        <input type="range" min="-90" max="90" step="1" name="wrist" id="wrist" value="0">
        <br>
        <label for="wrist_rot">Wrist rotation</label>
        <input type="range" min="0" max="180" step="1" name="wrist_rot" id="wrist_rot" value="90">
        <br>
        <label for="gripper">Gripper</label>
        <input type="range" min="0" max="180" step="1" name="gripper" id="gripper" value="90">
        <br>
        <input type="submit" value="Move">
      </form>
    </div>

    <form>
      <label for="x">X:</label>
      <input type="number" id="x" name="x"><br><br>
  
      <label for="y">Y:</label>
      <input type="number" id="y" name="y"><br><br>
  
      <label for="z">Z:</label>
      <input type="number" id="z" name="z"><br><br>
  
      <button type="button" id="submit-btn">Send Coordinates</button>
    </form>

    <div id="tabContainer">
      <!-- Tabs will be dynamically added here -->
    </div>
    <button onclick="addTab()">Add Tab</button>

    <div id="viewer"></div>

    <div class="tabs">
      <div class="tab-headers">
        <!-- Tab headers will be created dynamically here -->
      </div>
      <div class="tab-content">
        <!-- Tab content will be created dynamically here -->
      </div>
    </div>
    <button id="addNewTabBtn">Add New Tab</button>
    <button id="addPositionToActiveTabBtn">Add Position to Active Tab</button>
    <button id="deleteActiveTabBtn">Delete Active Tab</button>
    <button id="playSelectedTab">Play selected positions</button>
    
    <script type="module" src="../static/animation.js"></script>
    <script type="module">

      import { setArmRotation } from "../static/animation.js";
      document.getElementById('addNewTabBtn').addEventListener('click', addNewTab);
      document.getElementById('addPositionToActiveTabBtn').addEventListener('click', addPositionToActiveTab);
      document.getElementById('deleteActiveTabBtn').addEventListener('click', deleteActiveTab);
      document.getElementById('playSelectedTab').addEventListener('click', playSelectedTab);
      var tabCount = 0;
      var data = JSON.parse('{{ data|tojson|safe }}');

      function playSelectedTab(){
        const activeTabId = document.querySelector('.tab-header.active').textContent.split(' ')[1];
        $.ajax({
          type: "POST",
          url: "/play",
          contentType: "application/json",
          data: JSON.stringify(data[activeTabId]),
          success: function(response) {
            function delay(position){
              setTimeout(() => {
              console.log(response)
              setArmRotation(position.base, position.shoulder, position.elbow, position.wrist);
              }, 2000);
            }
            response.forEach(function(position){
              delay(position);
            });
          }
        });
      }


      function createTab(tabId, positions) {
        const tabHeaders = document.querySelector('.nav nav-tabs');
        const tabContent = document.querySelector('.list-group');
        
        tabCount++;
        // Create tab header
        const header = document.createElement('li');
        header.id = tabCount;
        header.classList.add('tab-header');
        header.textContent = `Tab ${tabCount}`;
        header.addEventListener('click', () => {
          const activeHeaders = document.querySelectorAll('.tab-header.active');
          activeHeaders.forEach(el => el.classList.remove('active'));
          header.classList.add('active');

          const activeTabs = document.querySelectorAll('.tab.active');
          activeTabs.forEach(el => el.classList.remove('active'));
          tab.classList.add('active');
        });
        tabHeaders.appendChild(header);

        // Create tab content
        const tab = document.createElement('li');
        tab.classList.add('tab');
        tab.id = tabCount;
        const list = document.createElement('ul');
        positions.forEach(position => {
          const listItem = document.createElement('li');
          listItem.textContent = JSON.stringify(position);
          list.appendChild(listItem);
        });
        tab.appendChild(list);
        tabContent.appendChild(tab);

        // Activate the first tab by default
        if (tabHeaders.childElementCount === 1) {
          header.classList.add('active');
          tab.classList.add('active');
        }
      }

      function addNewTab() {
        const newTabId = Object.keys(data).length + 1;
        data[newTabId] = [];
        createTab(newTabId, []);
      }

      // Initialize tabs with the provided data
      for (const tabId in data) {
        createTab(tabId, data[tabId]);
      }

      // Add position to the active tab
      function addPositionToActiveTab() {
        const activeTab = document.querySelector('.tab.active');
        if (!activeTab) return;
        const newPosition = {
          base: document.getElementById("base").value,
          elbow:  document.getElementById("elbow").value - 121,
          gripper: document.getElementById("gripper").value,
          shoulder: document.getElementById("shoulder").value - 24,
          wrist: document.getElementById("wrist").value - 90,
          wrist_rot: document.getElementById("wrist_rot").value,
        };


        const activeTabId = document.querySelector('.tab-header.active').textContent.split(' ')[1];
        data[activeTabId].push(newPosition);

        const listItem = document.createElement('li');
        listItem.textContent = JSON.stringify(newPosition);
        newPosition["movement_id"] = activeTab.id;
        $.ajax({
          type: "POST",
          url: "/add_position",
          contentType: "application/json",
          data: JSON.stringify(newPosition),
          success: function(response) {}
        });
        activeTab.querySelector('ul').appendChild(listItem);
      }

      // Delete active tab
      function deleteActiveTab() {
        tabCount--;
        const activeHeader = document.querySelector('.tab-header.active');
        const activeTab = document.querySelector('.tab.active');
        if (!activeHeader || !activeTab) return;

        const activeTabId = activeHeader.textContent.split(' ')[1];
        delete data[activeTabId];

        activeHeader.remove();
        activeTab.remove();

        // Activate the first remaining tab, if any
        const firstHeader = document.querySelector('.tab-header');
        if (firstHeader) {
          firstHeader.click();
        }
      }


      
    </script>
    
  </body>
</html>